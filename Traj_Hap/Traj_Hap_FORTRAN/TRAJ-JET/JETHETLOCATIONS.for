C     PROGRAM TO GENERATE UNIFORM LOCATION OF HETERODOMAINS IN A DISK. THE HETERODMAINS ARE LOCATED IN RINGS, 
C     EACH RING IS LOCATED FROM THE EQUATOR TO THE POLES, EACH RING IS LOCATED AT FIXED ELEVATION ANGLES, 
C     THE NUMBER OF HETERODOMAINS IS MINIMUM IN THE POLES ( A SINGLE HETERODOMAIN IN THE POLES) AND MAXIMUM AT THE EQUATOR, 
C     THE HETDOMAINS ARE LOCATED AT UNIFORM SPACING IN EACH RING BUT VARIABLE BETWEEN RINGS OF DIFFERENT RADIUS.
C
      PROGRAM JETHETLOCATIONS
C     
      IMPLICIT NONE
C
      DOUBLE PRECISION XHET(10000000),YHET(10000000),ZHET(10000000)
      DOUBLE PRECISION RHET(10000)
      DOUBLE PRECISION THETAT(10000000),PHIT(10000000)
C
      DOUBLE PRECISION PI,RJET,RHET0,RHET1,AHET,SCOV,SCOV1,SCOV2
      DOUBLE PRECISION R,R2,R3,R4
      DOUBLE PRECISION X,Y,Z,X1,Y1,Z1,X2,Y2,Z2,X3,Y3,Z3,X4,Y4,Z4
      DOUBLE PRECISION THETA,THETA1,THETA2,THETA3,THETA4
      DOUBLE PRECISION PHI,PHI1,PHI2,PHI3,PHI4,DTHETA,DPHI
      DOUBLE PRECISION PHIOFF,A,B,C,DET,RRING,RRING2,ARCL,NHETREAL,NHET2
      DOUBLE PRECISION Xm0,Ym0,ODD
C
      INTEGER I,J,K,L,M,N,NHET,NHET1,NRING,NHETRING,HETCOUNT
      INTEGER NHETTILE
C
      CHARACTER DUMMY*20       
C
C
C
      DATA PI/3.14159265359/
C
C     SET AXIS
      Xm0 = 0.0
      Ym0 = 0.0
C     INPUT COLLECTOR SIZE
      RJET = 5.0E-4
C     INPUT HETERODOMAIN SIZE AND SURFACE COVERAGE
      RHET0 = 120.0E-9
      RHET1 = RHET0/2.0
C     INPUT SURFACE COVERAGE 
      PRINT *,'BIMODAL DIST. HETERODOMAINS, INPUT SURFACE COVERAGE %'
      READ *, SCOV
C     TRANSFROM TO FRACTIONAL COVERAGE
      SCOV = SCOV/100  
C     SET NUMNER OF HETERODOMAINS PER TILE
      NHETTILE = 5          
C     EQUIVALENT SURFACE COVERAGE CORRESPONDING TO UNIFORM HETERODOMAINS IS USED IN CALCULATION, EQUALS HALF OF BIMODAL SURFACE COVERAGE
      IF (NHETTILE.EQ.1) THEN
        SCOV1 = SCOV
      ELSEIF (NHETTILE.EQ.5) THEN
        SCOV1 = SCOV/2.0
      END IF
C     CALULATE NUMBER OF HETERODOMAINS REQUIRED
      NHET = NINT(SCOV1*(RJET**2.0)/(RHET0**2.0))
      NHET2 = NHET*5
C     CALCULATE NUMBER OF RINGS THAT YIELD NHET ASSUMING EVEN SPACING 
      NHETREAL = NHET
C     DENOMINATOR 3.3 CALIBRATED TO MATCH SURFACE COVERAGE
      NRING = NINT((NHETREAL/3.3)**0.5)
C
C
C     OPEN HETDOMAIN OUTPUT FILE
      OPEN (UNIT=1,FILE='JETHETDOMAINS.DAT',STATUS='REPLACE')
C     WRITE HEADER AND LABELS
      WRITE (1,1000) RJET,SCOV,NHET,NRING
      WRITE (1,1001) 
1000  FORMAT('RJET= ',E14.8,2X,'SCOV= ',E14.8,2X,'NHET= ',I10,2X,
     &'NRING= ',I10)
1001  FORMAT (' RING ID X(m) Y(m) THETA(rad) PHI(rad) RHET(m)')
1002  FORMAT (2X,I10,2X,I10,2X,E15.8,2X,E15.8,2X,E15.8,2X,
     &E15.8,2X,E15.8)   
C
      OPEN (UNIT=2,FILE='NHETRING.DAT',STATUS='REPLACE')
      WRITE (2,2001) 
2001  FORMAT (' RING NHETRING')
2002  FORMAT (2X,I10,2X,I10)

C     CALUCLATED SCOV BASED ON BIMODAL SCOV (2*RHET0)
      SCOV = NHET*2*RHET0**2.0/(RJET**2.0)
      PRINT *,'Number of rings: ',NRING   
      PRINT *,'Number of hetdomains: ',NHET2
      PRINT *,'Surface coverage: ',SCOV               
      READ *,DUMMY
C     CALCULATE RADIAL STEP IN R 
      DTHETA =  RJET/NRING
C     INITITIALIZE ANGLE
      THETA = 0.0  
C     CALCULATE ARCLENGHT CONSTANT IN BOTH AZIMUTH AND ELEVATION
      ARCL = DTHETA
C     INITIALIZE HETDOMAIN COUNTER
      HETCOUNT = 0
C     SET INTEGRATOR OF HETERODOMAIN AREA TO ZERO
      AHET = 0.0
      PHI = 0.0
      RRING = 0.0 
      THETA = 0.0
C     GENERATE HETERODOMAINS AT AXIS
      DO J=1,NHETTILE
        I = 0.0
        IF (J.EQ.1) THEN 
C       GENERATE FIRST HETERODOMAIN
            XHET(J) = RRING*DCOS(PHI)+Xm0
            YHET(J) = RRING*DSIN(PHI)+Ym0 
            RHET(J) = RHET0
        ELSE
            N = 2
            ODD = MOD(J,N)
            IF (ODD.GT.0) THEN
                PHI = 0.0
                THETA1 = (J-4)*(1.0/3.0*DTHETA)
            ELSE 
                PHI = (J-3)*(1.0/3.0*DTHETA)
                THETA1 = 0.0
            END IF
            XHET(J) = THETA1+Xm0
            YHET(J) = PHI+Ym0
            RHET(J) = RHET1
        END IF                      
C       WRITE TO OUTPUT FILE
        WRITE (1,1002) I,J,XHET(J),YHET(J),THETA,PHI,RHET(J) 
      END DO
      HETCOUNT = HETCOUNT + 5
      WRITE (2,2002) I,NHETRING
      AHET = (PI*RHET1*RHET1)*4.0+(PI*RHET0*RHET0)+AHET
C
C       GENERATE HETERODOMAINS NOT AT AXIS    
      DO I=1,NRING           
C       CALCULATE ELEVATION ANGLE AND Z COMPONENT
        THETA = I*DTHETA  
C       CALCULATE RING RADIUS 
C       CALCULATE RING RADIUS
        RRING = THETA
C       CALCULATE AZIMUTH ANGLE STEP 1(CHANGES FOR EACH RING)
        NHETRING = INT(2.0*PI*RRING/ARCL)
        IF (NHETRING.LT.3) THEN
            NHETRING = 3
        ENDIF
C       RECALCULATE STEP IN PHI BASED ON NHETRING

        DPHI = 1.0/INT(RRING/ARCL)
        DPHI = ARCL/RRING
    

        DPHI = 2.0*PI/NHETRING !ANGLE IN RADIANS BETWEEN HETERODOMAINS ON A RING
C       CALCULATE OFFSET AS 10% OF THE STEP IN PHI IF RING IS ODD OR EVEN
        M = MOD(I,2)
        IF (M.EQ.0) THEN
             PHIOFF = 0.1*DPHI 
        ELSE
             PHIOFF = -0.1*DPHI 
        ENDIF
C       CALCULATE THE AZIMUTH ANGLE TAKING IN ACCOUNT THE OFFSET OF THE HETDOMINS IN EACH RING
        DO K=1,NHETRING
            PHI = DPHI*(K-1)+PHIOFF
C           GENERATE HETERODOMAINS NOT AT POLES
            DO J=1,NHETTILE
                IF (J.EQ.1) THEN 
C                   GENERATE FIRST HETERODOMAIN
                    XHET(J) = RRING*DCOS(PHI)+Xm0
                    YHET(J) = RRING*DSIN(PHI)+Ym0  
                    RHET(J) = RHET0
                ELSE 
                    IF (J.EQ.2) THEN 
                        RRING2 = RRING - (1.0/3.0*DTHETA) 
                        PHI1 = PHI - (1.0/3.0*DPHI)
                    END IF
                    IF (J.EQ.3) THEN 
                        RRING2 = RRING - (1.0/3.0*DTHETA)  
                        PHI1 = PHI + (1.0/3.0*DPHI)
                    END IF
                    IF (J.EQ.4) THEN 
                        RRING2 = RRING + (1.0/3.0*DTHETA)  
                        PHI1 = PHI + (1.0/3.0*DPHI) 
                    END IF
                    IF (J.EQ.5) THEN 
                        RRING2 = RRING + (1.0/6.0*DTHETA)  
                        PHI1 = PHI - (1.0/3.0*DPHI)
                    END IF                                   
                     XHET(J) = RRING2*DCOS(PHI1)
                     YHET(J) = RRING2*DSIN(PHI1)
                    RHET (J) = RHET1
                END IF   
C               WRITE TO OUTPUT FILE
                WRITE (1,1002) I,J,XHET(J),YHET(J),THETA,PHI,RHET(J)    
            END DO 
            HETCOUNT = HETCOUNT + 5  
            AHET = (PI*RHET1*RHET1)*4.0+(PI*RHET0*RHET0)+AHET      
        END DO
        WRITE (2,2002) I,NHETRING
        PRINT *, 'RING= ',I,' NHETRING= ',NHETRING
      ENDDO 
      CLOSE(1)
      SCOV2 = AHET/(PI*RJET**2.0)
      PRINT *, ' SCOV = ', SCOV
      PRINT *, ' SCOV2 = ', SCOV2
      PRINT *, ' HETCOUNT = ', HETCOUNT
      READ *, DUMMY 
C        
      END PROGRAM JETHETLOCATIONS