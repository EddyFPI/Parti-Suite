C     PROGRAM TO GENERATE UNIFORM LOCATION OF HETERODOMAINS IN A SPHERE. THE HETERODMAINS ARE LOCATED IN RINGS, 
C     EACH RING IS LOATDE FROM THE EQUATO TO THE POLES, EACH RING IS LOCATED AT FIXED ELEVATION ANGLES, 
C     THE NUMBER OF HETERODOMAINS IS MINIMUM IN THE POLES ( A SINGLE HETERODOMAIN IN THE POLES) AND MAXIMUM AT THE EQUATOR, 
C     THE HETDOMAINS ARE LOCATED AT UNIFORM ESPAING IN EACH RING BUT VARIABLE BETWEEN RINGS OF DIFFERENT RADIUS.
C
      PROGRAM HAPHETLOCATIONS
C     
      IMPLICIT NONE
C
      DOUBLE PRECISION XT(10000000),YT(10000000),ZT(10000000)
      DOUBLE PRECISION THETAT(10000000),PHIT(10000000)
C
      DOUBLE PRECISION PI,AG,RHET1,AHET,SCOV,X,Y,Z,THETA,PHI,DTHETA,DPHI
      DOUBLE PRECISION A,B,C,DET,R,OFFPHI
C
      INTEGER I,J,K,L,NHET,NHET1,NRING,NHETRING,NRINGEQ 
C
      CHARACTER DUMMY*20       
C
      DATA PI/3.14159265359/
C
C     INPUT COLLECTOR SIZE
      AG = 1.0E-3
C     INPUT HETERODOMAIN SIZE AND SURFACE COVERAGE
      RHET1 = 120.0E-9
      SCOV = 0.002/100
C     CALULATE NUMBER OF HETERODOMAINS REQUIRED
      NHET = NINT(SCOV*(4.0*AG**2.0)/(RHET1**2.0))
C     CALCULATE NUMBER OF RINGS THAT YIELD NHET ASSUMING LINEAR PROGRESSION
C     CHECK SUBSIDIARY DOCUMENTATION IN SPREADSHEET
      A = 1.0
      B = 2.0
      C = 1.0-NHET
      DET = B*B-4.0*A*C
      IF (DET.LT.0.0) THEN 
        PRINT *, 'Surface coverage too small, not enough heterodomains'
        PRINT *, 'to yield representativeuniform coverage'
        PRINT *, 'OUTPUT WILL BE INCORRECT'
        READ *,DUMMY
      ELSE
C       SOLVE QUADRATIC EQUATION, NOTE THAT NRING ALLWAYS WILL BE AND ODD INTEGER   
        NRING = 1+2.0*(NINT((-B+DET**0.5)/(2.0*A)))
C       CALCULATE ACTUAL NUMBER OF HETDOMAINS AND SURFACE COVERAGE
        NHET = 2*((NRING-1)/2+1)*((NRING-1)/4)+(NRING-1)/2+1
        SCOV = NHET*RHET1**2.0/(4.0*AG**2.0)
        PRINT *,'Number of rings: ',NRING   
        PRINT *,'Number of hetdomains: ',NHET
        PRINT *,'Surface coverage: ',SCOV               
        READ *,DUMMY
      ENDIF
C     CALCULATE SLEVATION ANGLE STEP
      DTHETA =  PI/(NRING-1)
C     INITITIALIZE ANGLE
      THETA = 0.0
C     DETERMINE EQUATOR RING NUMBER
      NRINGEQ = NRING/2+1
C     OPEN HETDOMAIN OUTPUT FILE
      OPEN (UNIT=1,FILE='HAPHETDOMAINS.DAT',STATUS='REPLACE')
C     WRITE HEADER AND LABELS
      WRITE (1,1000) AG,SCOV,NHET,NRING
      WRITE (1,1001) 
1000  FORMAT('AG= ',E14.8,2X,'SCOV= ',E14.8,2X,'NHET= ',I10,2X,
     &'NRING= ',I10)
1001  FORMAT (' RING ID X(m) Y(m) Z(m) THETA(rad) PHI(rad) RHET(m)')
1002  FORMAT (2X,I10,2X,I10,2X,E15.8,2X,E15.8,2X,E15.8,2X,E15.8,2X,
     &E15.8,2X,E15.8)   
C
C     GENERATE HETERODOMAINS FROM PI/2 TO -PI/2 THETA DOMAIN     
      DO I=1,NRING            
C       CALCULATE NUMBER OF HETDOMAINS PER RING AND STEP PHI ANGLE
        IF (I.LE.NRINGEQ) THEN
            NHETRING = I 
        ELSE
            NHETRING = 2*NRINGEQ-I
        ENDIF
C       CALCULATE ELEVATION ANGLE AND Z COMPONENT
        THETA = PI/2.0-I*DTHETA  
        Z = AG*DSIN(THETA)
C       CALCULATE AZIMUTH ANGLE STEP (CHANGES FOR EACH RING)
        DPHI = 2.0*PI/2.0-I*DTHETA 
C       CALCULATE RING RADIUS
        IF ((I.EQ.1).OR.(I.EQ.NRING)) THEN
            R = 0.0
            X = 0.0
            Y = 0.0
            IF (I.EQ.1) THEN
                Z = AG 
            ENDIF
            IF (I.EQ.NRING) THEN
                Z = -AG
            ENDIF
            J = 1
C           WRITE TO OUTPUT FILE
            WRITE (1,1002) I,J,X,Y,Z,THETA,PHI,RHET1
        ELSE
            R = AG*DCOS(THETA) 
            DO J=1,NHETRING
C               STAGGER LOCATION OF HETDOMAIN IN RINGS CLOSE TO POLES 
                IF ((NHETRING.GT.2).AND.(NHETRING.LT.100)) THEN 
                    OFFPHI=MOD(NHETRING,2)*PI/6.0
                ELSE
                    OFFPHI = 0.0
                ENDIF
                PHI = (J-1)*DPHI+OFFPHI
C               FORTRAN DOES NOT RECOGNIZE ANGLE VALUES GT.2.0*PI RADIANS
                IF (PHI.GT.(2.0*PI)) THEN 
                   PHI = 2.0*PI*((PHI)/(2.0*PI)-INT(PHI/(2.0*PI)))
                ENDIF
                X = R*DCOS(PHI)
                Y = R*DSIN(PHI)   
C               WRITE TO OUTPUT FILE
                WRITE (1,1002) I,J,X,Y,Z,THETA,PHI,RHET1               
            ENDDO 
        ENDIF
        PRINT *, 'RING= ',I,' NHETRING= ',NHETRING
      ENDDO 
      CLOSE(1)
      PRINT *, ' PROGRAM END '
      READ *, DUMMY 
C        
      END PROGRAM HAPHETLOCATIONS
